"""Administrative tools for configuring the webinar bot."""
from __future__ import annotations

from datetime import datetime
from pathlib import Path
from urllib.parse import urlparse

from telegram import ReplyKeyboardMarkup, ReplyKeyboardRemove, Update
from telegram.constants import ParseMode
from telegram.ext import (
    CommandHandler,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
)

import database
from config import is_admin, load_settings, update_settings
from scheduler import ensure_scheduler_started, schedule_all_reminders

BUTTON_SET_DATE = "üìÜ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É"
BUTTON_SET_TOPIC = "‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ"
BUTTON_SET_DESCRIPTION = "üìù –ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ"
BUTTON_SET_ZOOM = "üîó –û–±–Ω–æ–≤–∏—Ç—å Zoom"
BUTTON_SET_PAYMENT = "üí≥ –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É"
BUTTON_EXPORT = "üì• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
BUTTON_NOTIFY = "üì¢ –†–∞–∑–æ—Å–ª–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
BUTTON_SHOW_EVENT = "üóì –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"

MENU_KEYBOARD = ReplyKeyboardMarkup(
    [
        [BUTTON_SET_DATE, BUTTON_SET_TOPIC],
        [BUTTON_SET_DESCRIPTION],
        [BUTTON_SET_ZOOM, BUTTON_SET_PAYMENT],
        [BUTTON_EXPORT, BUTTON_NOTIFY],
        [BUTTON_SHOW_EVENT],
    ],
    resize_keyboard=True,
)

STATE_TOPIC, STATE_DATE, STATE_ZOOM, STATE_PAYMENT, STATE_NOTIFY, STATE_DESCRIPTION = range(6)

CANCEL_TEXT = "–æ—Ç–º–µ–Ω–∞"
CLEAR_TEXT = "–æ—á–∏—Å—Ç–∏—Ç—å"
TOPIC_MAX_LENGTH = 200


def _normalize_command_text(text: str | None) -> str:
    return (text or "").strip().lower()


def _is_cancel(text: str | None) -> bool:
    return _normalize_command_text(text) == CANCEL_TEXT


def _is_clear(text: str | None) -> bool:
    return _normalize_command_text(text) == CLEAR_TEXT


def _is_valid_url(value: str) -> bool:
    parsed = urlparse(value)
    return bool(parsed.scheme in {"http", "https"} and parsed.netloc)


MISSING_VALUE = "‚ùóÔ∏è–ù–µ —É–∫–∞–∑–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
_MONTH_NAMES = [
    "",
    "—è–Ω–≤–∞—Ä—è",
    "—Ñ–µ–≤—Ä–∞–ª—è",
    "–º–∞—Ä—Ç–∞",
    "–∞–ø—Ä–µ–ª—è",
    "–º–∞—è",
    "–∏—é–Ω—è",
    "–∏—é–ª—è",
    "–∞–≤–≥—É—Å—Ç–∞",
    "—Å–µ–Ω—Ç—è–±—Ä—è",
    "–æ–∫—Ç—è–±—Ä—è",
    "–Ω–æ—è–±—Ä—è",
    "–¥–µ–∫–∞–±—Ä—è",
]


def _is_admin(update: Update) -> bool:
    user = update.effective_user
    return bool(user and is_admin(chat_id=user.id, username=user.username))


def _format_value(value) -> str:
    if value is None:
        return MISSING_VALUE
    if isinstance(value, str):
        stripped = value.strip()
        if not stripped:
            return MISSING_VALUE
        return stripped
    return str(value)


def _format_datetime(dt: datetime) -> str:
    if 1 <= dt.month <= 12:
        month = _MONTH_NAMES[dt.month]
    else:
        month = dt.strftime("%B")
    return f"{dt.day} {month} {dt.year}, {dt.strftime('%H:%M')}"


def _try_parse_separate_datetime(date_str: str | None, time_str: str | None) -> datetime | None:
    if not date_str:
        return None

    date_str = date_str.strip()
    time_str = (time_str or "").strip()

    if time_str:
        candidate = f"{date_str} {time_str}".strip()
        for fmt in ("%Y-%m-%d %H:%M", "%d.%m.%Y %H:%M", "%d.%m.%y %H:%M"):
            try:
                return datetime.strptime(candidate, fmt)
            except ValueError:
                continue
    else:
        for fmt in ("%Y-%m-%d", "%d.%m.%Y", "%d.%m.%y"):
            try:
                return datetime.strptime(date_str, fmt)
            except ValueError:
                continue
    return None


async def _ensure_admin(update: Update, *, message: str = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.") -> bool:
    if _is_admin(update):
        return True
    if update.message:
        await update.message.reply_text(message)
    else:
        await update.effective_chat.send_message(message)
    return False


async def send_admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    settings = load_settings()
    text = (
        "<b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n"
        f"–ù–∞–∑–≤–∞–Ω–∏–µ: {_format_value(settings.get('topic'))}\n"
        f"–û–ø–∏—Å–∞–Ω–∏–µ: {_format_value(settings.get('description'))}\n"
        f"–î–∞—Ç–∞: {_format_value(settings.get('event_datetime'))}\n"
        f"Zoom: {_format_value(settings.get('zoom_link'))}\n"
        f"–û–ø–ª–∞—Ç–∞: {_format_value(settings.get('payment_link'))}"
    )
    if update.message:
        await update.message.reply_text(text, parse_mode=ParseMode.HTML, reply_markup=MENU_KEYBOARD)
    else:
        await update.effective_chat.send_message(text, parse_mode=ParseMode.HTML, reply_markup=MENU_KEYBOARD)


async def show_current_event(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END

    settings = load_settings()

    topic = _format_value(settings.get("topic"))
    description = _format_value(settings.get("description"))
    zoom_link = _format_value(settings.get("zoom_link"))
    payment_link = _format_value(settings.get("payment_link"))

    event_dt_text = MISSING_VALUE
    event_dt_obj: datetime | None = None

    event_iso = settings.get("event_datetime")
    if event_iso:
        try:
            event_dt_obj = datetime.fromisoformat(event_iso)
            event_dt_text = _format_datetime(event_dt_obj)
        except ValueError:
            event_dt_text = event_iso
    else:
        event_date = settings.get("event_date")
        event_time = settings.get("event_time")
        combined = " ".join(
            part.strip()
            for part in (event_date or "", event_time or "")
            if part and part.strip()
        )
        if combined:
            event_dt_text = combined
            event_dt_obj = _try_parse_separate_datetime(event_date, event_time)

    lines = [
        f"üéì –ù–∞–∑–≤–∞–Ω–∏–µ: {topic}",
        f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}",
        f"üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: {event_dt_text if event_dt_text.strip() else MISSING_VALUE}",
        f"üîó Zoom: {zoom_link}",
        f"üí≥ –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É: {payment_link}",
    ]

    if "timezone" in settings:
        timezone_value = _format_value(settings.get("timezone"))
        lines.append(f"üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {timezone_value}")

    known_fields = {
        "topic",
        "description",
        "event_datetime",
        "event_date",
        "event_time",
        "zoom_link",
        "payment_link",
        "timezone",
    }
    for key in sorted(settings):
        if key in known_fields:
            continue
        value_text = _format_value(settings.get(key))
        label = key.replace("_", " ").capitalize()
        lines.append(f"‚Ä¢ {label}: {value_text}")

    message = "\n".join(lines)

    if event_dt_obj and event_dt_obj < datetime.now(event_dt_obj.tzinfo):
        message += "\n\n‚ö†Ô∏è –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–∂–µ –ø—Ä–æ—à–ª–æ."

    if update.message:
        await update.message.reply_text(message, reply_markup=MENU_KEYBOARD)
    else:
        await update.effective_chat.send_message(message, reply_markup=MENU_KEYBOARD)

    return ConversationHandler.END


async def admin_command_entry(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update, message="–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."):
        return ConversationHandler.END
    await send_admin_panel(update, context)
    return ConversationHandler.END


async def set_topic_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤).\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: –û—Ç–º–µ–Ω–∞.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_TOPIC


async def set_topic_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    text = (update.message.text or "").strip()

    if _is_cancel(text):
        await update.message.reply_text("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    if not text:
        await update.message.reply_text("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return STATE_TOPIC

    if len(text) > TOPIC_MAX_LENGTH:
        await update.message.reply_text(
            f"–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º {TOPIC_MAX_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤."
        )
        return STATE_TOPIC

    update_settings(topic=text)
    await show_current_event(update, context)
    await update.message.reply_text("‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
    return ConversationHandler.END


async def set_description_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: –û—Ç–º–µ–Ω–∞, –û—á–∏—Å—Ç–∏—Ç—å.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_DESCRIPTION


async def set_description_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END

    raw_text = update.message.text or ""
    if _is_cancel(raw_text):
        await update.message.reply_text("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    if _is_clear(raw_text):
        update_settings(description=None)
        await show_current_event(update, context)
        await update.message.reply_text("–û–ø–∏—Å–∞–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    stripped = raw_text.strip()
    if not stripped:
        await update.message.reply_text(
            "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –û—á–∏—Å—Ç–∏—Ç—å."
        )
        return STATE_DESCRIPTION

    update_settings(description=stripped)
    await show_current_event(update, context)
    await update.message.reply_text("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
    return ConversationHandler.END


def _parse_datetime(text: str) -> datetime:
    text = text.strip()
    formats = ["%d.%m.%Y %H:%M", "%d.%m %H:%M"]
    for fmt in formats:
        try:
            dt = datetime.strptime(text, fmt)
            if fmt == "%d.%m %H:%M":
                dt = dt.replace(year=datetime.now().year)
            return dt
        except ValueError:
            continue
    raise ValueError("invalid format")


async def set_date_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú –∏–ª–∏ –î–î.–ú–ú –ß–ß:–ú–ú",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_DATE


async def set_date_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    text = update.message.text or ""
    try:
        event_dt = _parse_datetime(text)
    except ValueError:
        await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return STATE_DATE

    update_settings(event_datetime=event_dt.isoformat())
    ensure_scheduler_started()
    schedule_all_reminders(context.application)
    await show_current_event(update, context)
    await update.message.reply_text("–î–∞—Ç–∞ –≤–µ–±–∏–Ω–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
    return ConversationHandler.END


async def set_zoom_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é Zoom-—Å—Å—ã–ª–∫—É.\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: –û—Ç–º–µ–Ω–∞, –û—á–∏—Å—Ç–∏—Ç—å.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_ZOOM


async def set_zoom_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    text = update.message.text or ""

    if _is_cancel(text):
        await update.message.reply_text("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Zoom-—Å—Å—ã–ª–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    if _is_clear(text):
        update_settings(zoom_link=None)
        await show_current_event(update, context)
        await update.message.reply_text("–°—Å—ã–ª–∫–∞ Zoom –æ—á–∏—â–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
        schedule_all_reminders(context.application)
        return ConversationHandler.END

    link = text.strip()
    if not link or not _is_valid_url(link):
        await update.message.reply_text(
            "–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É (http/https) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –û—Ç–º–µ–Ω–∞/–û—á–∏—Å—Ç–∏—Ç—å."
        )
        return STATE_ZOOM

    update_settings(zoom_link=link)
    await show_current_event(update, context)
    await update.message.reply_text("–°—Å—ã–ª–∫–∞ Zoom –æ–±–Ω–æ–≤–ª–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
    schedule_all_reminders(context.application)
    return ConversationHandler.END


async def set_payment_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É (http/https).\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: –û—Ç–º–µ–Ω–∞, –û—á–∏—Å—Ç–∏—Ç—å.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_PAYMENT


async def set_payment_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    text = update.message.text or ""

    if _is_cancel(text):
        await update.message.reply_text("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    if _is_clear(text):
        update_settings(payment_link=None)
        await show_current_event(update, context)
        await update.message.reply_text("–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –æ—á–∏—â–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
        return ConversationHandler.END

    link = text.strip()
    if not link or not _is_valid_url(link):
        await update.message.reply_text(
            "–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É (http/https) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –û—Ç–º–µ–Ω–∞/–û—á–∏—Å—Ç–∏—Ç—å."
        )
        return STATE_PAYMENT

    update_settings(payment_link=link)
    await show_current_event(update, context)
    await update.message.reply_text("–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
    return ConversationHandler.END


async def export_participants(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    path = database.export_database()
    await update.message.reply_document(document=path.read_bytes(), filename=Path(path).name)
    return ConversationHandler.END


async def notify_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:",
        reply_markup=ReplyKeyboardRemove(),
    )
    return STATE_NOTIFY


async def notify_finish(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await _ensure_admin(update):
        return ConversationHandler.END
    text = update.message.text or ""
    participants = database.list_chat_ids()
    for chat_id in participants:
        await context.bot.send_message(chat_id=chat_id, text=text)
    await update.message.reply_text("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.", reply_markup=MENU_KEYBOARD)
    return ConversationHandler.END


def build_admin_conversation() -> ConversationHandler:
    return ConversationHandler(
        entry_points=[
            CommandHandler("admin", admin_command_entry),
            CommandHandler("set_topic", set_topic_start),
            CommandHandler("set_date", set_date_start),
            CommandHandler("set_zoom", set_zoom_start),
            CommandHandler("set_payment", set_payment_start),
            CommandHandler("export", export_participants),
            CommandHandler("notify", notify_start),
            CommandHandler("current_event", show_current_event),
            MessageHandler(filters.Regex("^‚úèÔ∏è"), set_topic_start),
            MessageHandler(filters.Regex("^üìù –ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ$"), set_description_start),
            MessageHandler(filters.Regex("^üìÜ"), set_date_start),
            MessageHandler(filters.Regex("^üîó"), set_zoom_start),
            MessageHandler(filters.Regex("^üí≥"), set_payment_start),
            MessageHandler(filters.Regex("^üì•"), export_participants),
            MessageHandler(filters.Regex("^üì¢"), notify_start),
            MessageHandler(filters.Regex("^üóì"), show_current_event),
        ],
        states={
            STATE_TOPIC: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_topic_finish)],
            STATE_DATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_date_finish)],
            STATE_ZOOM: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_zoom_finish)],
            STATE_PAYMENT: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_payment_finish)],
            STATE_NOTIFY: [MessageHandler(filters.TEXT & ~filters.COMMAND, notify_finish)],
            STATE_DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_description_finish)],
        },
        fallbacks=[CommandHandler("cancel", admin_command_entry)],
        allow_reentry=True,
    )
